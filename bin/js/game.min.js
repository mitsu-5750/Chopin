"use strict";let score={rank:null,board:0,max_combo:0,combo:0,perfect:0,good:0,bad:0,miss:0},notesData=null,music=new Howl({src:["songs/夜に駆ける/item.mp3"]}),audio={flick:new Howl({src:["bin/audio/perfect.mp3"]}),perfect:new Howl({src:["bin/audio/perfect.mp3"]}),good:new Howl({src:["bin/audio/good.mp3"]}),bad:new Howl({src:["bin/audio/bad.mp3"]})},notes=[[],[],[],[]],bpm=null,beat=0,bar=-1,gameStatus="stand";const MAIN=document.getElementById("MAIN"),LINES=document.querySelectorAll(".lines");class Note{constructor(line,type=1){this.line=line,this.type=type,this.y=110,this.el=null,this.show()}show(){this.el=document.createElement("img"),1==this.type&&(this.el.src=`bin/img/${DATA.type}.png`),2==this.type&&(this.el.src="bin/img/flick.png"),this.el.classList.add("notes"),LINES[this.line].insertAdjacentElement("afterbegin",this.el)}fall(){this.y-=1.8,this.el.style.bottom=`${this.y}%`,this.y<-10&&this.remove(this.lane)}remove(){this.el.remove(),notes[this.line].shift()}}function init(){notesData=noteCompile(),bpm=bpmCompile(),operation()}function musicStart(){gameStatus="start",console.info("演奏スタート"),update(),setTimeout(()=>{music.currentTime=DATA.music_offset,music.play(),setTimeout(()=>{music.currentTime=DATA.preview},Math.abs(DATA.music_offset))},DATA.play_offset)}function update(){showNotes(),"start"==gameStatus&&window.requestAnimationFrame(update)}function showNotes(){for(let lines of notes)for(let note of lines)note.fall();if(beat+DATA.offset<music.seek()&&bar!=notesData.length-1){beat+=bpm,bar++;for(let i=0;i<notesData[bar].length;i++)setTimeout(()=>{for(let noteLane=0;noteLane<notesData[bar][i].length;noteLane++){let notes_number;"0"!=notesData[bar][i].substr(noteLane,1)&&notes[noteLane].push(new Note(noteLane))}},bpm/notesData[bar].length*(1e3*i))}}function operation(){document.addEventListener("touchstart",event=>{if(event.preventDefault(),"stand"!=gameStatus)for(let p of event.changedTouches){let pos=getPos(p),mainWidth=MAIN.clientWidth/4;pos.x>0*mainWidth&&pos.x<1*mainWidth&&(judge(0),TapEffect(0)),pos.x>1*mainWidth&&pos.x<2*mainWidth&&(judge(1),TapEffect(1)),pos.x>2*mainWidth&&pos.x<3*mainWidth&&(judge(2),TapEffect(2)),pos.x>3*mainWidth&&pos.x<4*mainWidth&&(judge(3),TapEffect(3))}else musicStart()},{passive:!1})}function judge(line){if(notes[line][0])return notes[line][0].y>-6&&notes[line][0].y<6?takeNote("perfect",line):notes[line][0].y>-12&&notes[line][0].y<12?takeNote("good",line):notes[line][0].y>-24&&notes[line][0].y<24?takeNote("bad",line):void 0}function takeNote(judge,line){notes[line][0].remove(),0==notes[line][0].noteType&&audio[judge].play(),1==notes[line][0].noteType&&audio.flick.play()}function noteCompile(){try{let notesData=DATA.notes.replace(/^#.*/gm,"").replace(/\r|\n/g,"").split(";");for(let i=0;notesData.length>i;i++)notesData[i]=notesData[i].split(",");return notesData}catch(e){alert("楽曲データが見つかりませんでした\n選択画面に戻ります")}}function bpmCompile(){return 240/DATA.bpm}function TapEffect(line){LINES[line].style.backgroundColor="rgba(255, 255, 255, 0.1)",setTimeout(()=>{LINES[line].style.backgroundColor=null},50)}function getPos(pos){let windowPos=MAIN.getBoundingClientRect(),x=windowPos.left+window.pageXOffset,y=windowPos.top+window.pageYOffset;return{x:pos.pageX-x,y:pos.pageY-y}}function auto(){for(let i=0;i<notes.length;i++)notes[i][0]&&notes[i][0].y<0&&takeNote("perfect",i)}window.addEventListener("load",init);